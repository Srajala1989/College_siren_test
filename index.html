<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siren Admin | College IoT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: sans-serif; }
        .auth-card { max-width: 400px; margin: 100px auto; border-radius: 15px; }
        .dashboard-card { max-width: 800px; margin: 30px auto; border-radius: 15px; display: none; }
        .alarm-row { background: #fff; border: 1px solid #dee2e6; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .nav-pills .nav-link.active { background-color: #198754; }
    </style>
</head>
<body>

    <div id="authSection" class="card auth-card shadow-sm p-4">
        <h3 class="text-center text-success mb-4">Siren Admin Login</h3>
        <div class="mb-3">
            <input type="email" id="email" class="form-control" placeholder="Admin Email">
        </div>
        <div class="mb-3">
            <input type="password" id="password" class="form-control" placeholder="Password">
        </div>
        <button class="btn btn-success w-100" onclick="handleLogin()">Unlock Dashboard</button>
        <p id="loginError" class="text-danger small mt-2 text-center"></p>
    </div>

    <div id="dashboardSection" class="card dashboard-card shadow p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Siren Schedule Control</h2>
            <button class="btn btn-outline-danger btn-sm" onclick="handleLogout()">Logout</button>
        </div>

        <ul class="nav nav-pills nav-justified mb-4" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#reg">Regular Mode</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#exam">Exam Mode</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#spec">Special Alarms</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="reg">
                <div class="mb-3">
                    <label class="form-label fw-bold">Number of Alarms (Max 20):</label>
                    <input type="number" id="regCount" class="form-control w-25" min="0" max="20" onchange="renderInputs('reg')">
                </div>
                <div id="regInputsContainer"></div>
            </div>

            <div class="tab-pane fade" id="exam">
                <div class="mb-3">
                    <label class="form-label fw-bold">Number of Alarms (Max 20):</label>
                    <input type="number" id="examCount" class="form-control w-25" min="0" max="20" onchange="renderInputs('exam')">
                </div>
                <div id="examInputsContainer"></div>
            </div>

            <div class="tab-pane fade" id="spec">
                <div class="mb-3">
                    <label class="form-label fw-bold">Special One-Time Alarms (Max 5):</label>
                    <input type="number" id="specCount" class="form-control w-25" min="0" max="5" onchange="renderInputs('spec')">
                </div>
                <div id="specInputsContainer"></div>
            </div>
        </div>

        <button class="btn btn-success btn-lg w-100 mt-4" onclick="saveData()">Push to Siren</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        // 1. REPLACE THESE WITH YOUR FIREBASE PROJECT CONFIG
        const firebaseConfig = {
    apiKey: "AIzaSyDpdIb1KL0z8ha5dEsKopwbSokE7jCxt68",
    authDomain: "websirentest.firebaseapp.com",
    databaseURL: "https://websirentest-default-rtdb.firebaseio.com",
    projectId: "websirentest",
    storageBucket: "websirentest.firebasestorage.app",
    messagingSenderId: "38500208312",
    appId: "1:38500208312:web:0b98fb088e29304cba6e4d"
  };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- AUTH LOGIC ---
        window.handleLogin = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => {
                document.getElementById('loginError').innerText = "Login Failed: " + err.message;
            });
        };

        window.handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'block';
                loadExistingData();
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('dashboardSection').style.display = 'none';
            }
        });

        // --- UI LOGIC ---
        window.renderInputs = (mode, existingData = []) => {
            const count = document.getElementById(mode + 'Count').value;
            const container = document.getElementById(mode + 'InputsContainer');
            container.innerHTML = "";
            for (let i = 0; i < count; i++) {
                const type = mode === 'spec' ? 'datetime-local' : 'time';
                const val = existingData[i] || "";
                container.innerHTML += `
                    <div class="alarm-row">
                        <span>Alarm #${i + 1}</span>
                        <input type="${type}" class="form-control w-50 ${mode}-val" value="${val}">
                    </div>`;
            }
        };

        // --- DATA SYNC ---
        function loadExistingData() {
            onValue(ref(db, 'siren/schedule'), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (data.regular) {
                        document.getElementById('regCount').value = data.regular.length;
                        renderInputs('reg', data.regular);
                    }
                    if (data.exam) {
                        document.getElementById('examCount').value = data.exam.length;
                        renderInputs('exam', data.exam);
                    }
                    if (data.special) {
                        document.getElementById('specCount').value = data.special.length;
                        renderInputs('spec', data.special);
                    }
                }
            }, { onlyOnce: true });
        }

        window.saveData = () => {
            const data = {
                regular: Array.from(document.querySelectorAll('.reg-val')).map(el => el.value).filter(v => v),
                exam: Array.from(document.querySelectorAll('.exam-val')).map(el => el.value).filter(v => v),
                special: Array.from(document.querySelectorAll('.spec-val')).map(el => el.value).filter(v => v),
                lastUpdated: new Date().toISOString()
            };
            set(ref(db, 'siren/schedule'), data)
                .then(() => alert("Siren updated successfully!"))
                .catch(err => alert("Sync failed: " + err.message));
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
